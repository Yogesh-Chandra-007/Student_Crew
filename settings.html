<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings - Student Crew</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="settings.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="gradient-bg"></div>
  
  <!-- Navigation -->
  <nav class="main-nav">
    <div class="nav-brand">
      <i class="fas fa-users"></i>
      <span>Student Crew</span>
    </div>
    <div class="nav-links">
      <a href="dashboard.html"><i class="fas fa-home"></i> Home</a>
      <a href="sell.html"><i class="fas fa-plus-circle"></i> Sell</a>
      <a href="listings.html"><i class="fas fa-list"></i> Listings</a>
      <a href="inbox.html"><i class="fas fa-inbox"></i> Inbox</a>
    </div>
    <div class="nav-profile" onclick="toggleProfileMenu()">
      <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile" id="nav-profile-img">
      <div class="profile-menu" id="profileMenu">
        <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
        <a href="settings.html" class="active"><i class="fas fa-cog"></i> Settings</a>
        <a href="coins.html"><i class="fas fa-coins"></i> Coins</a>
        <a href="friends.html"><i class="fas fa-user-friends"></i> Friends</a>
        <div class="divider"></div>
        <a href="terms.html"><i class="fas fa-file-contract"></i> Terms</a>
        <a href="report.html"><i class="fas fa-bug"></i> Report Issue</a>
        <div class="divider"></div>
        <a href="#" class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>
  </nav>

  <div class="settings-container">
    <div class="tabs">
      <div class="tab active" data-tab="profile">Profile</div>
      <div class="tab" data-tab="password">Password</div>
      <div class="tab" data-tab="notifications">Notifications</div>
      <div class="tab" data-tab="privacy">Privacy</div>
      <div class="tab" data-tab="account">Account</div>
    </div>

    <!-- Profile Settings -->
    <div class="tab-content active" id="profile">
      <form id="profile-form">
        <div class="form-group"><label>Full Name</label><input type="text" id="full-name" required></div>
        <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
        <div class="form-group"><label>Phone</label><input type="text" id="phone"></div>
        <div class="form-group"><label>College</label><input type="text" id="college"></div>
        <div class="form-group"><label>Course</label><input type="text" id="course"></div>
        <div class="form-group"><label>Year</label>
          <select id="year">
            <option value="1">1st Year</option>
            <option value="2">2nd Year</option>
            <option value="3">3rd Year</option>
            <option value="4">4th Year</option>
          </select>
        </div>
        <div class="form-group"><label>Hostel Block</label><input type="text" id="block"></div>
        <div class="form-group"><label>Room</label><input type="text" id="room"></div>
        <div class="form-group">
          <label>Profile Picture</label>
          <input type="file" id="avatar-upload" accept="image/*">
          <div id="profile-preview-container" style="margin-top: 10px;">
            <img id="profile-preview" src="" alt="Preview" width="100" style="border-radius:50%;display:none;">
          </div>
        </div>
        <button type="submit" id="profile-save-btn">Save Profile</button>
      </form>
    </div>

    <!-- Password -->
    <div class="tab-content" id="password">
      <form id="password-form">
        <div class="form-group"><label>Current Password</label><input type="password" id="current-password" required></div>
        <div class="form-group"><label>New Password</label><input type="password" id="new-password" required minlength="6"></div>
        <div class="form-group"><label>Confirm New Password</label><input type="password" id="confirm-password" required minlength="6"></div>
        <button type="submit" id="password-save-btn">Update Password</button>
      </form>
    </div>

    <!-- Notifications -->
    <div class="tab-content" id="notifications">
      <form id="notifications-form">
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="email-notifications"> Email Notifications
          </label>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="sms-notifications"> SMS Notifications
          </label>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="push-notifications"> Push Notifications
          </label>
        </div>
        <button type="submit" id="notifications-save-btn">Save Notification Settings</button>
      </form>
    </div>

    <!-- Privacy -->
    <div class="tab-content" id="privacy">
      <form id="privacy-form">
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="show-email"> Show my email to others
          </label>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="show-phone"> Show my phone to others
          </label>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="show-profile"> Make my profile public
          </label>
        </div>
        <button type="submit" id="privacy-save-btn">Save Privacy Settings</button>
      </form>
    </div>

    <!-- Account -->
    <div class="tab-content" id="account">
      <div class="account-actions">
        <h3>Account Actions</h3>
        <p>Manage your account settings and data</p>
        
        <div class="action-buttons">
          <button id="export-data-btn">Export My Data</button>
          <button id="logout-btn" class="logout-btn">Sign Out</button>
          <button id="delete-btn" class="danger-btn">Delete Account</button>
        </div>
        
        <div class="account-info">
          <h4>Account Information</h4>
          <p><strong>User ID:</strong> <span id="user-id"></span></p>
          <p><strong>Account Created:</strong> <span id="account-created"></span></p>
          <p><strong>Last Login:</strong> <span id="last-login"></span></p>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>
  
  <script type="module">
    // Import the functions you need from the SDKs
    import { auth, db } from "./firebase-config.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import { onAuthStateChanged, updateEmail, updateProfile, updatePassword, signOut, deleteUser, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const storage = getStorage();
    const toast = document.getElementById("toast");
    let currentUser = null;
    let newProfilePicFile = null;

    // Toast notification
    function showToast(message, type = "success") {
      toast.textContent = message;
      toast.className = type === "error" ? "show error" : "show";
      setTimeout(() => { 
        toast.className = toast.className.replace("show", ""); 
      }, 3000);
    }

    // Tab switching functionality
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // Profile picture preview
    document.getElementById("avatar-upload").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        newProfilePicFile = file;
        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById("profile-preview").src = ev.target.result;
          document.getElementById("profile-preview").style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // Load user data
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      currentUser = user;
      
      // Update profile image in navigation
      if (user.photoURL) {
        document.getElementById("nav-profile-img").src = user.photoURL;
      }
      
      // Load user data from database
      try {
        const snapshot = await get(ref(db, "users/" + user.uid));
        if (snapshot.exists()) {
          const data = snapshot.val();
          
          // Fill form fields
          document.getElementById("full-name").value = data.name || user.displayName || "";
          document.getElementById("email").value = data.email || user.email || "";
          document.getElementById("phone").value = data.phone || "";
          document.getElementById("college").value = data.college || "";
          document.getElementById("course").value = data.course || "";
          document.getElementById("year").value = data.year || "1";
          document.getElementById("block").value = data.hostel?.block || "";
          document.getElementById("room").value = data.hostel?.room || "";
          
          // Set profile picture if available
          if (data.photoURL || user.photoURL) {
            const profilePic = data.photoURL || user.photoURL;
            document.getElementById("profile-preview").src = profilePic;
            document.getElementById("profile-preview").style.display = "block";
          }
          
          // Notifications settings
          document.getElementById("email-notifications").checked = data.settings?.emailNotifications || true;
          document.getElementById("sms-notifications").checked = data.settings?.smsNotifications || false;
          document.getElementById("push-notifications").checked = data.settings?.pushNotifications || true;
          
          // Privacy settings
          document.getElementById("show-email").checked = data.settings?.showEmail || false;
          document.getElementById("show-phone").checked = data.settings?.showPhone || false;
          document.getElementById("show-profile").checked = data.settings?.showProfile || true;
          
          // Account info
          document.getElementById("user-id").textContent = user.uid;
          if (data.createdAt) {
            document.getElementById("account-created").textContent = new Date(data.createdAt).toLocaleDateString();
          }
          if (data.lastLogin) {
            document.getElementById("last-login").textContent = new Date(data.lastLogin).toLocaleString();
          }
        } else {
          // Initialize user data if it doesn't exist
          await set(ref(db, "users/" + user.uid), {
            uid: user.uid,
            name: user.displayName || "",
            email: user.email || "",
            photoURL: user.photoURL || "",
            createdAt: Date.now(),
            lastLogin: Date.now(),
            settings: {
              emailNotifications: true,
              smsNotifications: false,
              pushNotifications: true,
              showEmail: false,
              showPhone: false,
              showProfile: true
            }
          });
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        showToast("Error loading profile data", "error");
      }
    });

    // Save profile
    document.getElementById("profile-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const saveBtn = document.getElementById("profile-save-btn");
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";
      
      try {
        const name = document.getElementById("full-name").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;
        const college = document.getElementById("college").value;
        const course = document.getElementById("course").value;
        const year = document.getElementById("year").value;
        const block = document.getElementById("block").value;
        const room = document.getElementById("room").value;

        let photoURL = currentUser.photoURL;
        
        // Upload new profile picture if selected
        if (newProfilePicFile) {
          const fileRef = storageRef(storage, `profilePics/${currentUser.uid}`);
          await uploadBytes(fileRef, newProfilePicFile);
          photoURL = await getDownloadURL(fileRef);
        }

        // Update profile in Firebase Auth
        await updateProfile(currentUser, { displayName: name, photoURL: photoURL });
        
        // Update email if changed
        if (email !== currentUser.email) {
          await updateEmail(currentUser, email);
        }

        // Update user data in database
        await set(ref(db, "users/" + currentUser.uid), {
          uid: currentUser.uid,
          name,
          email,
          phone,
          college,
          course,
          year,
          hostel: { block, room },
          photoURL: photoURL,
          settings: {
            emailNotifications: document.getElementById("email-notifications").checked,
            smsNotifications: document.getElementById("sms-notifications").checked,
            pushNotifications: document.getElementById("push-notifications").checked,
            showEmail: document.getElementById("show-email").checked,
            showPhone: document.getElementById("show-phone").checked,
            showProfile: document.getElementById("show-profile").checked
          },
          updatedAt: Date.now()
        }, { merge: true });

        // Update profile image in navigation
        document.getElementById("nav-profile-img").src = photoURL;
        
        showToast("Profile updated successfully!");
      } catch (error) {
        console.error("Error updating profile:", error);
        showToast("Error updating profile: " + error.message, "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Profile";
      }
    });

    // Password change
    document.getElementById("password-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const saveBtn = document.getElementById("password-save-btn");
      saveBtn.disabled = true;
      saveBtn.textContent = "Updating...";
      
      try {
        const currentPassword = document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;
        
        // Validate passwords match
        if (newPassword !== confirmPassword) {
          showToast("New passwords don't match", "error");
          saveBtn.disabled = false;
          saveBtn.textContent = "Update Password";
          return;
        }
        
        // Reauthenticate user
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update password
        await updatePassword(currentUser, newPassword);
        
        // Clear form
        document.getElementById("current-password").value = "";
        document.getElementById("new-password").value = "";
        document.getElementById("confirm-password").value = "";
        
        showToast("Password updated successfully!");
      } catch (error) {
        console.error("Error updating password:", error);
        showToast("Error updating password: " + error.message, "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Update Password";
      }
    });

    // Notifications
    document.getElementById("notifications-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const saveBtn = document.getElementById("notifications-save-btn");
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";
      
      try {
        await update(ref(db, "users/" + currentUser.uid + "/settings"), {
          emailNotifications: document.getElementById("email-notifications").checked,
          smsNotifications: document.getElementById("sms-notifications").checked,
          pushNotifications: document.getElementById("push-notifications").checked
        });
        
        showToast("Notification settings updated!");
      } catch (error) {
        console.error("Error updating notifications:", error);
        showToast("Error updating notifications", "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Notification Settings";
      }
    });

    // Privacy
    document.getElementById("privacy-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const saveBtn = document.getElementById("privacy-save-btn");
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";
      
      try {
        await update(ref(db, "users/" + currentUser.uid + "/settings"), {
          showEmail: document.getElementById("show-email").checked,
          showPhone: document.getElementById("show-phone").checked,
          showProfile: document.getElementById("show-profile").checked
        });
        
        showToast("Privacy settings updated!");
      } catch (error) {
        console.error("Error updating privacy settings:", error);
        showToast("Error updating privacy settings", "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Privacy Settings";
      }
    });

    // Logout
    document.getElementById("logout-btn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch (error) {
        console.error("Error signing out:", error);
        showToast("Error signing out", "error");
      }
    });

    // Delete Account
    document.getElementById("delete-btn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete your account? This action cannot be undone.")) return;
      
      try {
        // Delete user data from database
        await remove(ref(db, "users/" + currentUser.uid));
        
        // Delete user from authentication
        await deleteUser(currentUser);
        
        showToast("Account deleted successfully");
        setTimeout(() => {
          window.location.href = "signup.html";
        }, 2000);
      } catch (error) {
        console.error("Error deleting account:", error);
        showToast("Error deleting account: " + error.message, "error");
      }
    });

    // Export data
    document.getElementById("export-data-btn").addEventListener("click", async () => {
      if (!currentUser) return;
      
      try {
        const snapshot = await get(ref(db, "users/" + currentUser.uid));
        if (snapshot.exists()) {
          const userData = snapshot.val();
          const dataStr = JSON.stringify(userData, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          
          const exportFileDefaultName = `studentcrew-data-${currentUser.uid}.json`;
          
          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
          
          showToast("Data exported successfully!");
        }
      } catch (error) {
        console.error("Error exporting data:", error);
        showToast("Error exporting data", "error");
      }
    });
  </script>
  
  <script>
    // Add profile menu functionality (same as dashboard)
    function toggleProfileMenu() {
      const menu = document.getElementById("profileMenu");
      menu.classList.toggle("active");
    }

    // Close profile menu when clicking outside
    document.addEventListener('click', function(event) {
      const profileMenu = document.getElementById('profileMenu');
      const profileBtn = document.querySelector('.nav-profile');
      if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
        profileMenu.classList.remove('active');
      }
    });

    function logout() {
      // This will be handled by the module script
    }
  </script>
</body>
</html>
